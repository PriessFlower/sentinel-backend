# Sentinel Dashboard 规则配置详解

## 概述

Sentinel Dashboard 提供了多种规则类型来保护应用，每种规则都有其特定的参数和高级选项。本文档详细说明各种规则的配置参数和使用场景。

## 1. 流控规则 (Flow Control)

### 1.1 基本参数

| 参数 | 说明 | 示例值 | 必填 |
|------|------|--------|------|
| **资源名** | 受保护的资源名称 | `basic-resource` | ✅ |
| **针对来源** | 限流针对的调用来源 | `default` | ❌ |
| **阈值类型** | QPS 或 并发线程数 | `QPS` | ✅ |
| **单机阈值** | 每台机器的阈值 | `10` | ✅ |
| **是否集群** | 是否集群模式 | `否` | ❌ |

### 1.2 高级选项

#### 1.2.1 流控模式
- **直接**: 直接对资源进行限流
- **关联**: 当关联资源达到阈值时，对当前资源限流
- **链路**: 只统计指定链路上的流量

#### 1.2.2 流控效果
- **快速失败**: 直接抛出异常
- **Warm Up**: 预热模式，逐渐增加阈值
- **排队等待**: 请求排队，匀速通过

#### 1.2.3 预热参数 (Warm Up)
```
初始阈值 = 单机阈值 / 3
预热时间 = 10秒
```

#### 1.2.4 排队等待参数
```
超时时间 = 500ms
```

### 1.3 配置示例

```json
{
  "resource": "basic-resource",
  "grade": 1,
  "count": 10,
  "strategy": 0,
  "refResource": null,
  "controlBehavior": 0,
  "warmUpPeriodSec": 10,
  "maxQueueingTimeMs": 500,
  "clusterMode": false
}
```

## 2. 熔断规则 (Circuit Breaker)

### 2.1 基本参数

| 参数 | 说明 | 示例值 | 必填 |
|------|------|--------|------|
| **资源名** | 受保护的资源名称 | `slow-resource` | ✅ |
| **熔断策略** | 慢调用比例/异常比例/异常数 | `慢调用比例` | ✅ |
| **阈值** | 熔断触发的阈值 | `0.2` | ✅ |
| **最小请求数** | 最小统计请求数 | `5` | ✅ |
| **统计时长** | 统计时间窗口 | `10000ms` | ✅ |
| **熔断时长** | 熔断持续时间 | `10000ms` | ✅ |

### 2.2 熔断策略详解

#### 2.2.1 慢调用比例 (Slow Request Ratio)
- **阈值**: 0.0-1.0，表示慢调用比例
- **慢调用阈值**: 响应时间超过此值视为慢调用
- **适用场景**: 响应时间敏感的服务

#### 2.2.2 异常比例 (Exception Ratio)
- **阈值**: 0.0-1.0，表示异常比例
- **适用场景**: 异常率较高的服务

#### 2.2.3 异常数 (Exception Count)
- **阈值**: 整数，表示异常数量
- **适用场景**: 异常数量敏感的服务

### 2.3 高级选项

#### 2.3.1 熔断状态
- **关闭**: 正常状态，请求正常通过
- **打开**: 熔断状态，请求直接失败
- **半开**: 试探状态，允许部分请求通过

#### 2.3.2 状态转换条件
```
关闭 → 打开: 满足熔断条件
打开 → 半开: 熔断时长到期
半开 → 关闭: 试探请求成功
半开 → 打开: 试探请求失败
```

### 2.4 配置示例

```json
{
  "resource": "slow-resource",
  "grade": 0,
  "count": 0.2,
  "timeWindow": 10,
  "minRequestAmount": 5,
  "slowRatioThreshold": 0.2,
  "statIntervalMs": 1000
}
```

## 3. 热点参数规则 (Hot Parameter)

### 3.1 基本参数

| 参数 | 说明 | 示例值 | 必填 |
|------|------|--------|------|
| **资源名** | 受保护的资源名称 | `hot-resource` | ✅ |
| **参数索引** | 参数在方法中的位置 | `0` | ✅ |
| **单机阈值** | 每台机器的阈值 | `100` | ✅ |
| **统计窗口时长** | 统计时间窗口 | `10000ms` | ✅ |

### 3.2 高级选项

#### 3.2.1 参数类型
- **基本类型**: int, long, float, double, boolean, char, byte, short
- **字符串类型**: String
- **集合类型**: List, Set, Map

#### 3.2.2 参数例外项
- **参数值**: 特定参数值
- **限流阈值**: 该参数值的特殊阈值
- **适用场景**: 对特定参数值进行特殊限流

### 3.3 配置示例

```json
{
  "resource": "hot-resource",
  "grade": 1,
  "paramIdx": 0,
  "count": 100,
  "durationInSec": 10,
  "paramFlowItemList": [
    {
      "object": "123",
      "count": 200,
      "classType": "java.lang.String"
    }
  ]
}
```

## 4. 系统规则 (System Rule)

### 4.1 基本参数

| 参数 | 说明 | 示例值 | 必填 |
|------|------|--------|------|
| **系统负载** | 系统负载阈值 | `1.0` | ❌ |
| **CPU使用率** | CPU使用率阈值 | `0.8` | ❌ |
| **平均RT** | 平均响应时间阈值 | `1000ms` | ❌ |
| **并发线程数** | 并发线程数阈值 | `1000` | ❌ |
| **入口QPS** | 入口QPS阈值 | `10000` | ❌ |

### 4.2 高级选项

#### 4.2.1 系统保护策略
- **系统负载**: 基于系统负载的保护
- **CPU使用率**: 基于CPU使用率的保护
- **平均RT**: 基于平均响应时间的保护
- **并发线程数**: 基于并发线程数的保护
- **入口QPS**: 基于入口QPS的保护

#### 4.2.2 保护机制
- **自适应**: 根据系统状态自动调整
- **固定阈值**: 使用固定阈值进行保护

### 4.3 配置示例

```json
{
  "highestSystemLoad": 1.0,
  "highestCpuUsage": 0.8,
  "avgRt": 1000,
  "maxThread": 1000,
  "qps": 10000
}
```

## 5. 授权规则 (Authority Rule)

### 5.1 基本参数

| 参数 | 说明 | 示例值 | 必填 |
|------|------|--------|------|
| **资源名** | 受保护的资源名称 | `auth-resource` | ✅ |
| **流控应用** | 调用方应用名称 | `app1,app2` | ✅ |
| **授权类型** | 白名单或黑名单 | `白名单` | ✅ |

### 5.2 高级选项

#### 5.2.1 授权类型
- **白名单**: 只允许指定应用访问
- **黑名单**: 禁止指定应用访问

#### 5.2.2 应用名称来源
- **ContextUtil.enter()**: 通过上下文设置
- **RequestOriginParser**: 通过请求解析
- **自定义**: 通过自定义逻辑获取

### 5.3 配置示例

```json
{
  "resource": "auth-resource",
  "limitApp": "app1,app2",
  "strategy": 0
}
```

## 6. 规则配置最佳实践

### 6.1 流控规则配置建议

1. **QPS阈值设置**
   - 根据业务峰值设置
   - 考虑系统承载能力
   - 预留安全余量

2. **流控效果选择**
   - 快速失败: 适用于实时性要求高的场景
   - Warm Up: 适用于冷启动场景
   - 排队等待: 适用于允许延迟的场景

### 6.2 熔断规则配置建议

1. **阈值设置**
   - 慢调用比例: 0.1-0.3
   - 异常比例: 0.1-0.5
   - 异常数: 根据业务特点设置

2. **时间窗口设置**
   - 统计时长: 10-60秒
   - 熔断时长: 10-30秒

### 6.3 热点参数规则配置建议

1. **参数索引**
   - 从0开始计数
   - 注意参数位置变化

2. **阈值设置**
   - 根据参数重要性设置
   - 考虑参数值的分布

### 6.4 系统规则配置建议

1. **系统负载**
   - 一般设置为0.8-1.0
   - 根据服务器配置调整

2. **CPU使用率**
   - 一般设置为0.7-0.9
   - 考虑多核CPU特性

## 7. 规则监控和调优

### 7.1 监控指标

1. **流控规则**
   - QPS统计
   - 限流次数
   - 通过率

2. **熔断规则**
   - 熔断次数
   - 半开状态次数
   - 恢复时间

3. **热点参数规则**
   - 参数访问频率
   - 限流命中率

### 7.2 调优建议

1. **定期评估**
   - 根据业务变化调整规则
   - 监控规则效果
   - 优化规则参数

2. **A/B测试**
   - 对比不同规则配置
   - 评估业务影响
   - 选择最优配置

## 8. 常见问题解答

### 8.1 规则不生效
- 检查资源名称是否匹配
- 确认规则已发布
- 验证应用连接状态

### 8.2 规则配置错误
- 检查参数类型和范围
- 确认必填参数已填写
- 验证规则逻辑正确性

### 8.3 性能影响
- 监控规则执行开销
- 优化规则数量
- 考虑规则缓存

## 总结

Sentinel Dashboard 提供了丰富的规则配置选项，通过合理配置各种规则，可以有效保护应用免受流量冲击和异常影响。建议根据实际业务场景和系统特点，选择合适的规则类型和参数配置。
